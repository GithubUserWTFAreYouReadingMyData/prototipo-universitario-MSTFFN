<!DOCTYPE html>
<html lang="it">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizzazione Dati AIS - Analisi Traffico Navale</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
    #map {
    height: 100vh;
    width: 100vw;
}
    #controlPanel {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    width: 300px;
    max-height: 90vh;
    overflow-y: auto;
}
    .control-group {
    margin-bottom: 15px;
}
    label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}
    input, select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}
    button {
    width: 100%;
    padding: 10px;
    background: #2c3e50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 5px;
}
    button:hover {
    background: #34495e;
}
    .stats {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin-top: 10px;
    font-size: 0.9em;
}
    .legend {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}
    .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}
    .legend-color {
    width: 20px;
    height: 20px;
    margin-right: 10px;
    border-radius: 50%;
}
    .vessel-info {
    background: white;
    padding: 10px;
    border-radius: 4px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    max-width: 250px;
}
</style>
</head>
<body>
<div id="map"></div>

<div id="controlPanel">
    <h3 style="margin-top: 0; color: #2c3e50;">Controlli Dati AIS</h3>

    <div class="control-group">
        <label for="dataFile">File Dati AIS:</label>
        <select id="dataFile">
            <option value="aisnet_20260117Z120457.csv">17/01/2026 12:04 (55K navi)</option>
            <option value="aisnet_20260117Z110451.csv">17/01/2026 11:14 (55K navi)</option>
            <option value="aisnet_20260117Z083441.csv">17/01/2026 08:44 (57K navi)</option>
            <option value="aisnet_20260116Z135248.csv">16/01/2026 14:02 (68K navi)</option>
        </select>
        <button id="loadData">Carica Dati</button>
    </div>

    <div class="control-group">
        <label>Filtri Velocità (nodi):</label>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="minSpeed" placeholder="Min" value="0" style="flex: 1;">
                <input type="number" id="maxSpeed" placeholder="Max" value="50" style="flex: 1;">
        </div>
        <button id="applyFilters">Applica Filtri</button>
    </div>

    <div class="control-group">
        <label>Visualizzazione:</label>
        <div>
            <label><input type="checkbox" id="showDirection" checked> Mostra direzione</label><br>
            <label><input type="checkbox" id="clusterMarkers" checked> Raggruppa navi vicine</label>
        </div>
    </div>

    <div class="stats" id="statsPanel">
        <strong>Statistiche:</strong><br>
        Dati non caricati
    </div>

    <div class="legend">
        <strong>Legenda Velocità:</strong>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #2ecc71;"></div>
            <span>0-5 nodi (fermo/manovra)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #3498db;"></div>
            <span>6-15 nodi (lento)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #e74c3c;"></div>
            <span>16+ nodi (veloce)</span>
        </div>
    </div>

    <div style="margin-top: 15px; font-size: 0.8em; color: #666;">
        <strong>Per analisi algoritmica:</strong>
        <p>Tutti i dati sono disponibili nell'oggetto <code>aisData</code> nella console JavaScript.</p>
    </div>
</div>

<script>
    // Inizializzazione mappa
    const map = L.map('map').setView([40.8518, 14.2681], 10); // Centro su Napoli

    // Layer mappa
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

    // Layer per i marcatori
    let vesselMarkers = L.layerGroup().addTo(map);
    let markerCluster = null;

    // Struttura dati globale per analisi
    window.aisData = {
    raw: [],
    filtered: [],
    vessels: new Map(), // Raggruppa per MMSI
    stats: {
    total: 0,
    filtered: 0,
    bySpeedCategory: { slow: 0, medium: 0, fast: 0 }
}
};

    // Funzione per ottenere colore in base alla velocità
    function getSpeedColor(speed) {
    if (speed <= 5) return '#2ecc71';    // Verde - fermo/manovra
    if (speed <= 15) return '#3498db';   // Blu - velocità moderata
    return '#e74c3c';                    // Rosso - alta velocità
}

    // Creazione marcatore nave
    function createVesselMarker(vessel) {
    // Icona orientata secondo la rotta
    const icon = L.divIcon({
    className: 'vessel-marker',
    html: `
                    <div style="
                        width: 20px;
                        height: 20px;
                        background: ${getSpeedColor(vessel.speed)};
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 0 5px rgba(0,0,0,0.5);
                        transform: rotate(${vessel.heading}deg);
                        position: relative;
                    ">
                        <div style="
                            position: absolute;
                            top: -10px;
                            left: 50%;
                            transform: translateX(-50%);
                            width: 2px;
                            height: 10px;
                            background: black;
                            display: ${document.getElementById('showDirection').checked ? 'block' : 'none'}
                        "></div>
                    </div>
                `,
    iconSize: [24, 24],
    iconAnchor: [12, 12]
});

    const marker = L.marker([vessel.lat, vessel.lon], { icon });

    // Popup informativo
    const popupContent = `
                <div class="vessel-info">
                    <strong>MMSI:</strong> ${vessel.mmsi}<br>
                    <strong>Posizione:</strong> ${vessel.lat.toFixed(4)}, ${vessel.lon.toFixed(4)}<br>
                    <strong>Velocità:</strong> ${vessel.speed.toFixed(1)} nodi<br>
                    <strong>Rotta:</strong> ${vessel.heading}°<br>
                    <strong>Timestamp:</strong> ${new Date(vessel.timestamp).toLocaleString()}<br>
                    <hr>
                    <small>Clicca per selezionare per analisi</small>
                </div>
            `;

    marker.bindPopup(popupContent);

    // Evento per selezione nave (per algoritmo)
    marker.on('click', function() {
    console.log('Nave selezionata per analisi:', vessel);
    // Espone i dati della nave selezionata per elaborazione successiva
    window.selectedVessel = vessel;

    // Esempio di dati strutturati per algoritmo
    const algorithmData = {
    mmsi: vessel.mmsi,
    position: [vessel.lat, vessel.lon],
    speed: vessel.speed,
    heading: vessel.heading,
    timestamp: vessel.timestamp,
    nearbyVessels: findNearbyVessels(vessel, 0.1) // Navi entro 0.1 gradi
};
    console.log('Dati per algoritmo:', algorithmData);
});

    return marker;
}

    // Trova navi vicine (per analisi algoritmica)
    function findNearbyVessels(vessel, radiusDegrees) {
    return aisData.filtered.filter(v => {
    if (v.mmsi === vessel.mmsi) return false;
    const latDiff = Math.abs(v.lat - vessel.lat);
    const lonDiff = Math.abs(v.lon - vessel.lon);
    return latDiff < radiusDegrees && lonDiff < radiusDegrees;
});
}

    // Caricamento dati CSV
    async function loadAISData(filename) {
    try {
    const response = await fetch(`https://data.meteo.uniparthenope.it/instruments/aisnet0/csv/${filename}`);
    const csvText = await response.text();

    // Parsing CSV (struttura semplificata - adatta in base al formato reale)
    const lines = csvText.split('\n').slice(1); // Rimuovi header
    aisData.raw = [];

    lines.forEach(line => {
    if (!line.trim()) return;

    const parts = line.split(',');
    if (parts.length >= 6) {
    const vessel = {
    timestamp: parts[0] || new Date().toISOString(),
    mmsi: parts[1]?.trim() || 'N/A',
    lon: parseFloat(parts[2]) || 0,
    lat: parseFloat(parts[3]) || 0,
    heading: parseFloat(parts[4]) || 0,
    speed: parseFloat(parts[5]) || 0
};

    // Filtra coordinate valide
    if (vessel.lat && vessel.lon &&
    vessel.lat >= -90 && vessel.lat <= 90 &&
    vessel.lon >= -180 && vessel.lon <= 180) {
    aisData.raw.push(vessel);
}
}
});

    console.log(`Dati caricati: ${aisData.raw.length} navi`);
    applyFilters();

} catch (error) {
    console.error('Errore caricamento dati:', error);
    alert('Errore nel caricamento dei dati. Controlla la console per dettagli.');
}
}

    // Applicazione filtri
    function applyFilters() {
    const minSpeed = parseFloat(document.getElementById('minSpeed').value) || 0;
    const maxSpeed = parseFloat(document.getElementById('maxSpeed').value) || 100;

    aisData.filtered = aisData.raw.filter(vessel =>
    vessel.speed >= minSpeed && vessel.speed <= maxSpeed
    );

    // Aggiorna statistiche
    updateStatistics();

    // Aggiorna visualizzazione
    updateMapDisplay();
}

    // Aggiorna statistiche
    function updateStatistics() {
    aisData.stats.total = aisData.raw.length;
    aisData.stats.filtered = aisData.filtered.length;

    aisData.stats.bySpeedCategory = {
    slow: aisData.filtered.filter(v => v.speed <= 5).length,
    medium: aisData.filtered.filter(v => v.speed > 5 && v.speed <= 15).length,
    fast: aisData.filtered.filter(v => v.speed > 15).length
};

    // Aggiorna pannello statistiche
    document.getElementById('statsPanel').innerHTML = `
                <strong>Statistiche:</strong><br>
                Totale navi: ${aisData.stats.total}<br>
                Navi visualizzate: ${aisData.stats.filtered}<br>
                Per velocità:<br>
                • 0-5 nodi: ${aisData.stats.bySpeedCategory.slow}<br>
                • 6-15 nodi: ${aisData.stats.bySpeedCategory.medium}<br>
                • 16+ nodi: ${aisData.stats.bySpeedCategory.fast}
            `;

    // Espone le statistiche per analisi
    console.log('Statistiche AIS:', aisData.stats);
}

    // Aggiorna visualizzazione mappa
    function updateMapDisplay() {
    // Rimuovi marcatori esistenti
    vesselMarkers.clearLayers();
    if (markerCluster) {
    markerCluster.clearLayers();
}

    // Crea nuovi marcatori
    const markers = aisData.filtered.map(createVesselMarker);

    // Applica clustering se abilitato
    if (document.getElementById('clusterMarkers').checked) {
    if (!markerCluster) {
    // Carica cluster plugin dinamicamente
    if (typeof L.markerClusterGroup === 'undefined') {
    // Includi script per clustering
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';
    script.onload = () => {
    markerCluster = L.markerClusterGroup();
    markers.forEach(m => markerCluster.addLayer(m));
    map.addLayer(markerCluster);
};
    document.head.appendChild(script);
} else {
    markerCluster = L.markerClusterGroup();
    markers.forEach(m => markerCluster.addLayer(m));
    map.addLayer(markerCluster);
}
} else {
    markers.forEach(m => markerCluster.addLayer(m));
}
} else {
    // Aggiungi marcatori individuali
    markers.forEach(marker => vesselMarkers.addLayer(marker));
}

    // Aggiusta zoom se ci sono dati
    if (aisData.filtered.length > 0) {
    const bounds = L.latLngBounds(aisData.filtered.map(v => [v.lat, v.lon]));
    map.fitBounds(bounds, { padding: [50, 50] });
}
}

    // Gestione eventi UI
    document.getElementById('loadData').addEventListener('click', () => {
    const filename = document.getElementById('dataFile').value;
    loadAISData(filename);
});

    document.getElementById('applyFilters').addEventListener('click', applyFilters);

    document.getElementById('showDirection').addEventListener('change', updateMapDisplay);
    document.getElementById('clusterMarkers').addEventListener('change', updateMapDisplay);

    // Carica dati iniziali
    loadAISData('aisnet_20260117Z120457.csv');

    // Gestione errori migliorata
    window.addEventListener('error', function(e) {
    console.error('Errore JavaScript:', e.error);
});

    // API per algoritmi esterni
    window.AISAnalyzer = {
    getVesselsInArea: function(lat, lon, radiusKm) {
    const radiusDeg = radiusKm / 111; // Approssimazione gradi->km
    return aisData.filtered.filter(vessel => {
    const latDiff = Math.abs(vessel.lat - lat);
    const lonDiff = Math.abs(vessel.lon - lon);
    return Math.sqrt(latDiff*latDiff + lonDiff*lonDiff) < radiusDeg;
});
},

    getVesselTrajectory: function(mmsi) {
    // Per implementazione completa con dati storici
    console.log('Funzionalità traiettoria: richiede dati temporali multipli');
    return aisData.filtered.filter(v => v.mmsi === mmsi);
},

    exportData: function(format = 'json') {
    if (format === 'json') {
    return JSON.stringify(aisData.filtered, null, 2);
}
    return aisData.filtered;
}
};
</script>
</body>
</html>
